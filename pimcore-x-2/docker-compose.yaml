version: '2.4'
services:
  db:
    image: mariadb:10.4
    working_dir: /application
    command: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --innodb-file-format=Barracuda, --innodb-large-prefix=1, --innodb-file-per-table=1]
    volumes:
      - pimcore-database:/var/lib/mysql
      - ./data/init-db:/docker-entrypoint-initdb.d
    ports:
      - 3306:3306
    environment:
      - MYSQL_ROOT_PASSWORD=ROOT
      - MYSQL_DATABASE=pimcore
      - MYSQL_USER=pimcore
      - MYSQL_PASSWORD=pimcore

  adminer:
    image: adminer
    ports:
      - 8080:8080

  php:
    image: pimcore/pimcore:PHP8.0-apache-buster
    volumes:
      - .:/var/www/html:cached
    ports:
     - 80:80
     - 443:443
    environment: 
      PIMCORE_ADMIN_USER: admin
      PIMCORE_ADMIN_PSW: pimcore
      PIMCORE_DB_USER: pimcore
      PIMCORE_DB_PSW: pimcore
      PIMCORE_DB_NAME: pimcore
      PIMCORE_DB_HOST: db
      PIMCORE_DB_PORT: 3306
    depends_on:
     - db

  php-debug:
    image: pimcore/pimcore:PHP8.0-apache-buster-debug
    volumes:
      - .:/var/www/html:cached
    ports:
     - 88:80
    environment:
      PIMCORE_ADMIN_USER: admin
      PIMCORE_ADMIN_PSW: pimcore
      PIMCORE_DB_USER: pimcore
      PIMCORE_DB_PSW: pimcore
      PIMCORE_DB_NAME: pimcore
      PIMCORE_DB_HOST: db
      PIMCORE_DB_PORT: 3306
      XDEBUG_SERVER_NAME: localhost
      XDEBUG_IDE_KEY: pimcore
      XDEBUG_REMOTE_HOST: host.docker.internal
      XDEBUG_REMOTE_CONNECT_BACK: 0
      XDEBUG_REMOTE_PORT: 9003 
      PHP_IDE_CONFIG: "serverName=${XDEBUG_SERVER_NAME}"
      XDEBUG_CONFIG: "idekey=${XDEBUG_IDE_KEY} remote_host=${XDEBUG_REMOTE_HOST} remote_port=${XDEBUG_REMOTE_PORT} max_nesting_level=9999 max_nesting_level=9999"
    depends_on:
     - db
volumes:
  pimcore-database:
